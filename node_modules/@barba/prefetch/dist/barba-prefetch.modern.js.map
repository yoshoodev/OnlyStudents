{"version":3,"file":"barba-prefetch.modern.js","sources":["../src/polyfills/requestIdleCallback.ts","../src/prefetch.ts"],"sourcesContent":["/**\n * @module prefetch/polyfills\n */\n/**\n * Copyright 2018 Google Inc.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n// [source](https://github.com/GoogleChromeLabs/quicklink/blob/master/src/request-idle-callback.mjs)\n// RIC and shim for browsers setTimeout() without it\nexport const requestIdleCallback =\n  // @ts-ignore\n  window.requestIdleCallback ||\n  function ric(cb: any) {\n    const start = Date.now();\n\n    return setTimeout(() => {\n      cb({\n        didTimeout: false,\n        timeRemaining: function timeRemaining() {\n          return Math.max(0, 50 - (Date.now() - start));\n        },\n      });\n    }, 1);\n  };\n","/**\n * @barba/prefetch\n * <br><br>\n * ## Barba prefetch.\n *\n * @module prefetch\n * @preferred\n */\n\nimport { IPrefetchOptions } from './defs';\n\n/***/\n\n// Definitions\nimport { Core } from '@barba/core/src/core';\nimport { IBarbaPlugin, Link } from '@barba/core/src/defs';\nimport { Logger } from '@barba/core/src/modules/Logger';\n\nimport { version } from '../package.json';\nimport { requestIdleCallback } from './polyfills';\n\nclass Prefetch implements IBarbaPlugin<IPrefetchOptions> {\n  public name = '@barba/prefetch';\n  public version = version;\n  public barba: Core;\n  public logger: Logger;\n\n  public observer: IntersectionObserver;\n  public root: HTMLElement | HTMLDocument;\n  public timeout: number;\n  public toPrefetch: Set<string> = new Set();\n\n  /**\n   * Plugin installation.\n   */\n  public install(\n    barba: Core,\n    { root = document.body, timeout = 2e3 }: IPrefetchOptions = {}\n  ) {\n    this.logger = new barba.Logger(this.name);\n    this.logger.info(this.version);\n    this.barba = barba;\n    this.root = root;\n    this.timeout = timeout;\n  }\n\n  /**\n   * Plugin initialisation.\n   */\n  public init() {\n    if (this.barba.prefetchIgnore) {\n      this.logger.warn('barba.prefetchIgnore is enabled');\n\n      return;\n    }\n    if (this.barba.cacheIgnore) {\n      this.logger.warn('barba.cacheIgnore is enabled');\n\n      return;\n    }\n\n    /**\n     * Init intersection observer\n     * when intersecting, it will check if URL should be prefetched\n     * then unobserve the element\n     * and, if no cache data, fetch the page\n     */\n    /* istanbul ignore next */\n    this.observer = new IntersectionObserver(entries => {\n      entries.forEach(entry => {\n        if (entry.isIntersecting) {\n          const link = entry.target as Link;\n          const href = this.barba.dom.getHref(link);\n\n          if (this.toPrefetch.has(href)) {\n            this.observer.unobserve(link);\n            // Prefetch and cache\n            if (!this.barba.cache.has(href)) {\n              this.barba.cache.set(\n                href,\n                this.barba\n                  .request(\n                    href,\n                    this.barba.timeout,\n                    this.barba['onRequestError'].bind(this.barba, 'barba') // tslint:disable-line:no-string-literal\n                  )\n                  .catch(error => {\n                    this.logger.error(error);\n                  }),\n                'prefetch'\n              );\n            } else {\n              this.barba.cache.update(href, { action: 'prefetch' });\n            }\n          }\n        }\n      });\n    });\n    this.observe();\n    // Register hooks\n    this.barba.hooks.after(this.observe, this);\n  }\n\n  /* istanbul ignore next */\n  public observe(): void {\n    const timeout = this.timeout;\n\n    requestIdleCallback(\n      () => {\n        // If not, find all links and use IntersectionObserver.\n        this.root.querySelectorAll('a').forEach(el => {\n          const link = (el as unknown) as Link;\n          const href = this.barba.dom.getHref(link);\n\n          if (\n            !this.barba.cache.has(href) &&\n            !this.barba.prevent.checkHref(href) &&\n            !this.barba.prevent.checkLink(link, {} as Event, href)\n          ) {\n            this.observer.observe(el);\n            this.toPrefetch.add(href);\n          }\n        });\n      },\n      { timeout }\n    );\n  }\n}\n\nconst prefetch = new Prefetch();\n\nexport default prefetch;\n"],"names":["requestIdleCallback","window","cb","start","Date","now","setTimeout","didTimeout","timeRemaining","Math","max","prefetch","this","version","Set","install","barba","root","document","body","timeout","logger","Logger","name","info","init","prefetchIgnore","warn","cacheIgnore","observer","IntersectionObserver","entries","forEach","entry","isIntersecting","link","target","href","_this","dom","getHref","toPrefetch","has","unobserve","cache","update","action","set","request","bind","error","observe","hooks","after","_this2","querySelectorAll","el","prevent","checkHref","checkLink","add"],"mappings":"eAqBaA,EAEXC,OAAOD,qBACP,SAAaE,GACX,IAAMC,EAAQC,KAAKC,MAEnB,OAAOC,WAAW,WAChBJ,EAAG,CACDK,YAAY,EACZC,cAAe,WACb,OAAOC,KAAKC,IAAI,EAAG,IAAMN,KAAKC,MAAQF,QAGzC,IC+FDQ,EAAW,eA5GjB,aACSC,UAAO,kBACPA,aAAUC,EAOVD,gBAA0B,IAAIE,+BAK9BC,QAAA,SACLC,sBAC4D,SAA1DC,KAAAA,aAAOC,SAASC,WAAMC,QAAAA,aAAU,MAElCR,KAAKS,OAAS,IAAIL,EAAMM,OAAOV,KAAKW,MACpCX,KAAKS,OAAOG,KAAKZ,KAAKC,SACtBD,KAAKI,MAAQA,EACbJ,KAAKK,KAAOA,EACZL,KAAKQ,QAAUA,KAMVK,KAAA,sBACDb,KAAKI,MAAMU,eACbd,KAAKS,OAAOM,KAAK,mCAIff,KAAKI,MAAMY,YACbhB,KAAKS,OAAOM,KAAK,iCAYnBf,KAAKiB,SAAW,IAAIC,qBAAqB,SAAAC,GACvCA,EAAQC,QAAQ,SAAAC,GACd,GAAIA,EAAMC,eAAgB,CACxB,IAAMC,EAAOF,EAAMG,OACbC,EAAOC,EAAKtB,MAAMuB,IAAIC,QAAQL,GAEhCG,EAAKG,WAAWC,IAAIL,KACtBC,EAAKT,SAASc,UAAUR,GAEnBG,EAAKtB,MAAM4B,MAAMF,IAAIL,GAexBC,EAAKtB,MAAM4B,MAAMC,OAAOR,EAAM,CAAES,OAAQ,aAdxCR,EAAKtB,MAAM4B,MAAMG,IACfV,EACAC,EAAKtB,MACFgC,QACCX,EACAC,EAAKtB,MAAMI,QACXkB,EAAKtB,MAAL,eAA6BiC,KAAKX,EAAKtB,MAAO,gBAEzC,SAAAkC,GACLZ,EAAKjB,OAAO6B,MAAMA,KAEtB,kBASZtC,KAAKuC,UAELvC,KAAKI,MAAMoC,MAAMC,MAAMzC,KAAKuC,QAASvC,UAIhCuC,QAAA,sBAGLnD,EACE,WAEEsD,EAAKrC,KAAKsC,iBAAiB,KAAKvB,QAAQ,SAAAwB,GACtC,IAAMrB,EAAQqB,EACRnB,EAAOiB,EAAKtC,MAAMuB,IAAIC,QAAQL,GAGjCmB,EAAKtC,MAAM4B,MAAMF,IAAIL,IACrBiB,EAAKtC,MAAMyC,QAAQC,UAAUrB,IAC7BiB,EAAKtC,MAAMyC,QAAQE,UAAUxB,EAAM,GAAaE,KAEjDiB,EAAKzB,SAASsB,QAAQK,GACtBF,EAAKb,WAAWmB,IAAIvB,OAI1B,CAAEjB,QAnBYR,KAAKQ"}